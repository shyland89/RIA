{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/supabase/server.ts"],"sourcesContent":["import { createServerClient } from \"@supabase/ssr\";\nimport { cookies } from \"next/headers\";\n\nexport async function createClient() {\n  const cookieStore = await cookies();\n\n  return createServerClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\n    {\n      cookies: {\n        getAll() {\n          return cookieStore.getAll();\n        },\n        setAll(cookiesToSet) {\n          try {\n            cookiesToSet.forEach(({ name, value, options }) =>\n              cookieStore.set(name, value, options)\n            );\n          } catch {\n            // The `setAll` method was called from a Server Component.\n            // This can be ignored if you have middleware refreshing user sessions.\n          }\n        },\n      },\n    }\n  );\n}\n"],"names":[],"mappings":";;;;AAAA;AAAA;AACA;;;AAEO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,4IAAO;IAEjC,OAAO,IAAA,iMAAkB,sUAGvB;QACE,SAAS;YACP;gBACE,OAAO,YAAY,MAAM;YAC3B;YACA,QAAO,YAAY;gBACjB,IAAI;oBACF,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE,GAC5C,YAAY,GAAG,CAAC,MAAM,OAAO;gBAEjC,EAAE,OAAM;gBACN,0DAA0D;gBAC1D,uEAAuE;gBACzE;YACF;QACF;IACF;AAEJ"}},
    {"offset": {"line": 77, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/get-user-org.ts"],"sourcesContent":["import { createClient } from \"@/lib/supabase/server\";\n\nexport type UserOrg = {\n  user: { id: string; email: string };\n  membership: { org_id: string; role: string };\n  org: { id: string; name: string };\n};\n\nexport type UserOrgError = {\n  error: string;\n  status: number;\n};\n\nexport async function getUserOrg(): Promise<UserOrg | UserOrgError> {\n  const supabase = await createClient();\n\n  const {\n    data: { user },\n    error: authError,\n  } = await supabase.auth.getUser();\n\n  console.log(\"[getUserOrg] auth user:\", user?.id ?? \"null\", authError?.message ?? \"ok\");\n\n  if (!user) {\n    return { error: \"Unauthorized\", status: 401 };\n  }\n\n  const { data: rpcResult, error: rpcError } = await supabase.rpc(\"get_user_org\");\n\n  console.log(\n    \"[getUserOrg] RPC get_user_org =>\",\n    rpcResult ? JSON.stringify(rpcResult) : \"null\",\n    rpcError ? `error: ${rpcError.message}` : \"ok\"\n  );\n\n  if (rpcError) {\n    console.error(\"[getUserOrg] RPC error, falling back to direct queries:\", rpcError.message);\n    return await getUserOrgFallback(supabase, user);\n  }\n\n  if (rpcResult?.error) {\n    if (rpcResult.error === \"No membership found\") {\n      return {\n        error: \"No membership found. You may need to create an organization or contact support.\",\n        status: 403,\n      };\n    }\n    return { error: rpcResult.error, status: 500 };\n  }\n\n  return {\n    user: { id: user.id, email: user.email ?? \"\" },\n    membership: { org_id: rpcResult.org_id, role: rpcResult.role },\n    org: { id: rpcResult.org_id, name: rpcResult.org_name },\n  };\n}\n\nasync function getUserOrgFallback(\n  supabase: Awaited<ReturnType<typeof createClient>>,\n  user: { id: string; email?: string }\n): Promise<UserOrg | UserOrgError> {\n  const { data: membership, error: memError } = await supabase\n    .from(\"memberships\")\n    .select(\"org_id, role\")\n    .eq(\"user_id\", user.id)\n    .maybeSingle();\n\n  console.log(\n    \"[getUserOrg fallback] membership lookup =>\",\n    membership ? JSON.stringify(membership) : \"null\",\n    memError ? `error: ${memError.message}` : \"ok\"\n  );\n\n  if (!membership) {\n    return {\n      error: \"No membership found. You may need to create an organization or contact support.\",\n      status: 403,\n    };\n  }\n\n  const { data: org, error: orgError } = await supabase\n    .from(\"organizations\")\n    .select(\"id, name\")\n    .eq(\"id\", membership.org_id)\n    .maybeSingle();\n\n  console.log(\n    \"[getUserOrg fallback] org lookup =>\",\n    org ? JSON.stringify(org) : \"null\",\n    orgError ? `error: ${orgError.message}` : \"ok\"\n  );\n\n  if (!org) {\n    return {\n      error: \"Organization record not found. Please contact support.\",\n      status: 500,\n    };\n  }\n\n  return {\n    user: { id: user.id, email: user.email ?? \"\" },\n    membership: { org_id: membership.org_id, role: membership.role },\n    org: { id: org.id, name: org.name },\n  };\n}\n\nexport function isUserOrgError(result: UserOrg | UserOrgError): result is UserOrgError {\n  return \"error\" in result;\n}\n"],"names":[],"mappings":";;;;;;AAAA;;AAaO,eAAe;IACpB,MAAM,WAAW,MAAM,IAAA,2IAAY;IAEnC,MAAM,EACJ,MAAM,EAAE,IAAI,EAAE,EACd,OAAO,SAAS,EACjB,GAAG,MAAM,SAAS,IAAI,CAAC,OAAO;IAE/B,QAAQ,GAAG,CAAC,2BAA2B,MAAM,MAAM,QAAQ,WAAW,WAAW;IAEjF,IAAI,CAAC,MAAM;QACT,OAAO;YAAE,OAAO;YAAgB,QAAQ;QAAI;IAC9C;IAEA,MAAM,EAAE,MAAM,SAAS,EAAE,OAAO,QAAQ,EAAE,GAAG,MAAM,SAAS,GAAG,CAAC;IAEhE,QAAQ,GAAG,CACT,oCACA,YAAY,KAAK,SAAS,CAAC,aAAa,QACxC,WAAW,CAAC,OAAO,EAAE,SAAS,OAAO,EAAE,GAAG;IAG5C,IAAI,UAAU;QACZ,QAAQ,KAAK,CAAC,2DAA2D,SAAS,OAAO;QACzF,OAAO,MAAM,mBAAmB,UAAU;IAC5C;IAEA,IAAI,WAAW,OAAO;QACpB,IAAI,UAAU,KAAK,KAAK,uBAAuB;YAC7C,OAAO;gBACL,OAAO;gBACP,QAAQ;YACV;QACF;QACA,OAAO;YAAE,OAAO,UAAU,KAAK;YAAE,QAAQ;QAAI;IAC/C;IAEA,OAAO;QACL,MAAM;YAAE,IAAI,KAAK,EAAE;YAAE,OAAO,KAAK,KAAK,IAAI;QAAG;QAC7C,YAAY;YAAE,QAAQ,UAAU,MAAM;YAAE,MAAM,UAAU,IAAI;QAAC;QAC7D,KAAK;YAAE,IAAI,UAAU,MAAM;YAAE,MAAM,UAAU,QAAQ;QAAC;IACxD;AACF;AAEA,eAAe,mBACb,QAAkD,EAClD,IAAoC;IAEpC,MAAM,EAAE,MAAM,UAAU,EAAE,OAAO,QAAQ,EAAE,GAAG,MAAM,SACjD,IAAI,CAAC,eACL,MAAM,CAAC,gBACP,EAAE,CAAC,WAAW,KAAK,EAAE,EACrB,WAAW;IAEd,QAAQ,GAAG,CACT,8CACA,aAAa,KAAK,SAAS,CAAC,cAAc,QAC1C,WAAW,CAAC,OAAO,EAAE,SAAS,OAAO,EAAE,GAAG;IAG5C,IAAI,CAAC,YAAY;QACf,OAAO;YACL,OAAO;YACP,QAAQ;QACV;IACF;IAEA,MAAM,EAAE,MAAM,GAAG,EAAE,OAAO,QAAQ,EAAE,GAAG,MAAM,SAC1C,IAAI,CAAC,iBACL,MAAM,CAAC,YACP,EAAE,CAAC,MAAM,WAAW,MAAM,EAC1B,WAAW;IAEd,QAAQ,GAAG,CACT,uCACA,MAAM,KAAK,SAAS,CAAC,OAAO,QAC5B,WAAW,CAAC,OAAO,EAAE,SAAS,OAAO,EAAE,GAAG;IAG5C,IAAI,CAAC,KAAK;QACR,OAAO;YACL,OAAO;YACP,QAAQ;QACV;IACF;IAEA,OAAO;QACL,MAAM;YAAE,IAAI,KAAK,EAAE;YAAE,OAAO,KAAK,KAAK,IAAI;QAAG;QAC7C,YAAY;YAAE,QAAQ,WAAW,MAAM;YAAE,MAAM,WAAW,IAAI;QAAC;QAC/D,KAAK;YAAE,IAAI,IAAI,EAAE;YAAE,MAAM,IAAI,IAAI;QAAC;IACpC;AACF;AAEO,SAAS,eAAe,MAA8B;IAC3D,OAAO,WAAW;AACpB"}},
    {"offset": {"line": 167, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/import/execute/route.ts"],"sourcesContent":["import { createClient } from \"@/lib/supabase/server\";\nimport { getUserOrg, isUserOrgError } from \"@/lib/get-user-org\";\nimport { NextResponse } from \"next/server\";\nimport { parse } from \"csv-parse/sync\";\n\nconst REQUIRED_FIELDS = [\"name\", \"role\", \"industry\", \"source\", \"amount\", \"outcome\"] as const;\nconst VALID_OUTCOMES = [\"open\", \"won\", \"lost\"];\n\nexport async function POST(request: Request) {\n  const result = await getUserOrg();\n\n  if (isUserOrgError(result)) {\n    return NextResponse.json({ error: result.error }, { status: result.status });\n  }\n\n  const supabase = await createClient();\n  const user = result.user;\n  const orgId = result.membership.org_id;\n\n  const formData = await request.formData();\n  const file = formData.get(\"file\") as File | null;\n  const mappingJson = formData.get(\"mapping\") as string | null;\n\n  if (!file || !mappingJson) {\n    return NextResponse.json(\n      { error: \"File and column mapping are required\" },\n      { status: 400 }\n    );\n  }\n\n  let mapping: Record<string, string>;\n  try {\n    mapping = JSON.parse(mappingJson);\n  } catch {\n    return NextResponse.json(\n      { error: \"Invalid mapping format\" },\n      { status: 400 }\n    );\n  }\n\n  for (const field of REQUIRED_FIELDS) {\n    if (!mapping[field]) {\n      return NextResponse.json(\n        { error: `Missing mapping for required field: ${field}` },\n        { status: 400 }\n      );\n    }\n  }\n\n  const text = await file.text();\n  let records: Record<string, string>[];\n  try {\n    records = parse(text, {\n      columns: true,\n      skip_empty_lines: true,\n      trim: true,\n      bom: true,\n    });\n  } catch (e: any) {\n    return NextResponse.json(\n      { error: `CSV parse error: ${e.message}` },\n      { status: 400 }\n    );\n  }\n\n  const { data: job, error: jobError } = await supabase\n    .from(\"import_jobs\")\n    .insert({\n      org_id: orgId,\n      user_id: user.id,\n      filename: file.name,\n      inserted_count: 0,\n      error_count: 0,\n    })\n    .select(\"id\")\n    .single();\n\n  if (jobError || !job) {\n    return NextResponse.json(\n      { error: `Failed to create import job: ${jobError?.message}` },\n      { status: 500 }\n    );\n  }\n\n  const jobId = job.id;\n  let insertedCount = 0;\n  const errors: { row_number: number; error_message: string; raw_row_json: any }[] = [];\n\n  for (let i = 0; i < records.length; i++) {\n    const row = records[i];\n    const rowNum = i + 2;\n    const rowErrors: string[] = [];\n\n    const name = row[mapping.name]?.trim() || \"\";\n    const role = row[mapping.role]?.trim() || \"\";\n    const industry = row[mapping.industry]?.trim() || \"\";\n    const source = row[mapping.source]?.trim() || \"\";\n    const amountStr = row[mapping.amount]?.trim() || \"\";\n    const outcome = row[mapping.outcome]?.trim()?.toLowerCase() || \"\";\n    const createdAtStr = mapping.created_at ? row[mapping.created_at]?.trim() : undefined;\n\n    if (!name) rowErrors.push(\"name is required\");\n    if (!role) rowErrors.push(\"role is required\");\n    if (!industry) rowErrors.push(\"industry is required\");\n    if (!source) rowErrors.push(\"source is required\");\n\n    const amount = parseFloat(amountStr);\n    if (!amountStr || isNaN(amount)) {\n      rowErrors.push(\"amount must be a valid number\");\n    }\n\n    if (!VALID_OUTCOMES.includes(outcome)) {\n      rowErrors.push(`outcome must be one of: ${VALID_OUTCOMES.join(\", \")} (got \"${outcome}\")`);\n    }\n\n    let createdAt: string | undefined;\n    if (createdAtStr) {\n      const d = new Date(createdAtStr);\n      if (isNaN(d.getTime())) {\n        rowErrors.push(\"created_at is not a valid date\");\n      } else {\n        createdAt = d.toISOString();\n      }\n    }\n\n    if (rowErrors.length > 0) {\n      errors.push({\n        row_number: rowNum,\n        error_message: rowErrors.join(\"; \"),\n        raw_row_json: row,\n      });\n      continue;\n    }\n\n    const insertData: any = {\n      org_id: orgId,\n      name,\n      role,\n      industry,\n      source,\n      amount,\n      outcome,\n    };\n    if (createdAt) {\n      insertData.created_at = createdAt;\n    }\n\n    const { error: insertError } = await supabase\n      .from(\"opportunities\")\n      .insert(insertData);\n\n    if (insertError) {\n      errors.push({\n        row_number: rowNum,\n        error_message: insertError.message,\n        raw_row_json: row,\n      });\n    } else {\n      insertedCount++;\n    }\n  }\n\n  if (errors.length > 0) {\n    const errorInserts = errors.map((e) => ({\n      job_id: jobId,\n      row_number: e.row_number,\n      error_message: e.error_message,\n      raw_row_json: e.raw_row_json,\n    }));\n    await supabase.from(\"import_errors\").insert(errorInserts);\n  }\n\n  await supabase\n    .from(\"import_jobs\")\n    .update({\n      inserted_count: insertedCount,\n      error_count: errors.length,\n    })\n    .eq(\"id\", jobId);\n\n  return NextResponse.json({\n    jobId,\n    insertedCount,\n    errorCount: errors.length,\n    totalRows: records.length,\n    errors: errors.slice(0, 50),\n  });\n}\n"],"names":[],"mappings":"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"}}]
}